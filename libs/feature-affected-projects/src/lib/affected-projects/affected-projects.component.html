<ng-container *ngIf="(depGraph$ | async) as depGraph; else: loading">
  <div class="header" fxLayout fxLayoutGap="20px">
    <div fxFlex fxLayoutAlign="start center" fxLayout="row" fxLayoutGap="10px">
      <mat-form-field>
        <mat-select [formControl]="branchCtrl" placeholder="Base branch">
          <mat-option
            *ngFor="let option of (gitBranches$ | async)"
            [value]="option"
            >{{ option }}</mat-option
          >
        </mat-select>
      </mat-form-field>
      <mat-form-field class="form-field-wide">
        <input
          matInput
          placeholder="Filter projects"
          type="text"
          [formControl]="filterCtrl"
          [matAutocomplete]="projectsAutocomplete"
        />
        <button
          mat-button
          *ngIf="filterCtrl.value"
          matSuffix
          mat-icon-button
          aria-label="Clear"
          (click)="filterCtrl.setValue('')"
        >
          <mat-icon>close</mat-icon>
        </button>
        <mat-hint align="start">Show projects matching the filter.</mat-hint>
        <mat-autocomplete #projectsAutocomplete="matAutocomplete">
          <mat-option
            *ngFor="let option of (filteredProjects$ | async)"
            [value]="option"
            >{{ option }}</mat-option
          >
        </mat-autocomplete>
      </mat-form-field>
    </div>
    <div fxLayoutAlign="start center" fxLayout="row" fxLayoutGap="10px">
      <button
        mat-stroked-button
        (click)="testSelected()"
        [disabled]="!route.snapshot.params.project"
      >
        Test selected
      </button>
      <button
        mat-stroked-button
        color="primary"
        (click)="testAffected()"
        [disabled]="depGraph?.criticalPath.length === 0"
      >
        Test affected
      </button>
    </div>
  </div>
  <div class="content">
    <div *ngIf="(pendingRequest$ | async)" class="pending">
      <ng-container *ngTemplateOutlet="loading"></ng-container>
    </div>
    <angular-console-sankey-diagram
      [selected]="project$ | async"
      [data]="depGraph"
      [filter]="filterCtrl.value"
      (nodeSelected)="onNodeSelected($event)"
    ></angular-console-sankey-diagram>
  </div>
</ng-container>

<ng-template #loading>
  <div fxLayout="row" fxLayoutAlign="center center" fxFill>
    <mat-spinner diameter="48"> </mat-spinner>
  </div>
</ng-template>
